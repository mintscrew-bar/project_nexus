# 내전 진행 흐름 최종 분석 보고서

## 📋 내전 진행 흐름 개요

### 전체 흐름

```
1. WAITING (대기)
   ↓ 호스트가 경매/드래프트 시작
2. TEAM_SELECTION (팀 선택 모드)
   ↓ 경매/드래프트 시작
3. DRAFT (드래프트 진행 중)
   ↓ 경매/드래프트 완료
4. DRAFT_COMPLETED (드래프트 완료)
   ↓ 역할 선택 시작
5. ROLE_SELECTION (역할 선택)
   ↓ 역할 선택 완료 → 대진표(브래킷) 자동 생성
6. ★ 대진표 단계 (IN_PROGRESS)
   - 화면: /tournaments/[id]/bracket (대진표 페이지)
   - 매치 진행: 코드 생성 → 매치 시작 → 결과 보고
   ↓ 모든 매치 완료
7. COMPLETED (토너먼트 완료)
```

**대진표 포함**: 흐름 6번이 곧 「대진표」 단계이며, 여기서 대진표를 보면서 매치를 진행합니다.

---

## ✅ 해결된 문제점

### 1. 상태 전환 중복 업데이트 문제 ✅ 해결

**문제**:
- 브래킷 생성과 역할 선택 완료에서 룸 상태를 중복 업데이트
- 브래킷 생성 실패 시에도 상태가 변경됨

**해결**:
- 브래킷 생성이 룸 상태를 업데이트하도록 통일
- 브래킷 생성 실패 시 에러 throw하여 상태 변경 방지

---

### 2. 브래킷 중복 생성 문제 ✅ 해결

**문제**:
- 브래킷 생성이 여러 번 호출되면 매치가 중복 생성될 수 있음

**해결**:
- 브래킷 생성 전 기존 매치 확인
- 기존 브래킷이 있으면 반환
- 트랜잭션으로 원자성 보장

---

### 3. 에러 처리 부족 ✅ 해결

**문제**:
- 브래킷 생성 실패 시 에러를 무시하고 계속 진행
- 사용자에게 명확한 피드백 부족

**해결**:
- 브래킷 생성 실패 시 명확한 에러 메시지
- WebSocket으로 에러 이벤트 전송
- 상태 불일치 방지

---

## 🔍 각 단계별 검증

### 1. 룸 생성 → 팀 구성

**검증 항목**:
- ✅ 최소 인원 충족 확인
- ✅ 호스트 권한 확인
- ✅ 경매/드래프트 설정 확인

**상태 전환**:
- `WAITING` → `TEAM_SELECTION` → `DRAFT` → `DRAFT_COMPLETED`

---

### 2. 역할 선택

**검증 항목**:
- ✅ 모든 팀원이 역할 선택했는지 확인
- ✅ 타이머 만료 시 자동 할당

**상태 전환**:
- `DRAFT_COMPLETED` → `ROLE_SELECTION`

---

### 3. 브래킷 생성

**검증 항목**:
- ✅ 룸 상태: `ROLE_SELECTION`
- ✅ 호스트 권한 확인
- ✅ 각 팀 5명 확인
- ✅ 브래킷 중복 생성 방지

**상태 전환**:
- `ROLE_SELECTION` → `IN_PROGRESS` (브래킷 생성 성공 시)

**에러 처리**:
- 브래킷 생성 실패 시 상태 유지
- 명확한 에러 메시지 전달

---

### 4. 매치 시작

**검증 항목**:
- ✅ 호스트 권한 확인
- ✅ 매치 상태: `PENDING`
- ✅ 팀 할당 확인 (TBD 아님)

**Tournament Code**:
- 선택사항 (필수 아님)
- Riot API 실패 시 플레이스홀더 코드 사용

---

### 5. 결과 보고

**검증 항목**:
- ✅ 호스트 권한 확인
- ✅ 매치 상태: `IN_PROGRESS`
- ✅ 승자 팀 ID 검증
- ✅ 팀 할당 확인

**승자 진출**:
- Single Elimination: 다음 라운드로 진출
- Double Elimination: 승자/패자 라우팅
- Round Robin: 승자 진출 없음 (리그전)

---

### 6. 토너먼트 완료

**완료 조건**:
- ✅ 모든 매치가 `COMPLETED` 상태
- ✅ 최종 승자 결정

**처리**:
- 룸 상태 업데이트 (`COMPLETED`)
- Discord 알림 전송
- 최종 순위 계산

---

## 🎯 브래킷 타입별 동작

### 1. SINGLE (2팀)
- 단일 매치
- 승자 진출 없음
- 완료 시 토너먼트 종료

### 2. ROUND_ROBIN (3,5,6,7팀)
- 리그전 방식
- 각 팀이 모든 다른 팀과 한 번씩 경기
- 승자 진출 없음
- 최종 순위는 승수로 결정

### 3. SINGLE_ELIMINATION (4,8팀)
- 단일 토너먼트
- 승자는 다음 라운드로 진출
- 패자는 탈락

### 4. DOUBLE_ELIMINATION (4,8팀)
- 더블 엘리미네이션
- 승자조/패자조 분리
- 승자/패자 라우팅 로직 적용

---

## ⚠️ 주의사항

### 1. Tournament Code
- 선택사항 (필수 아님)
- Riot API 실패 시에도 매치 진행 가능
- 매치 데이터 수집은 Tournament Code가 있을 때만 가능

### 2. Round Robin
- 승자 진출 로직 없음 (정상)
- 최종 순위 계산 로직 필요 (현재는 없음)

### 3. 상태 불일치 방지
- 브래킷 생성 실패 시 룸 상태 유지
- 트랜잭션으로 원자성 보장

---

## 🧪 테스트 시나리오

### 정상 흐름
1. ✅ 룸 생성 → 경매/드래프트 → 역할 선택 → 브래킷 생성 → 매치 진행 → 완료

### 에러 케이스
1. ✅ 브래킷 생성 실패 시 상태 유지 확인
2. ✅ TBD 매치 시작 시도 시 에러 확인
3. ✅ 브래킷 중복 생성 시 기존 브래킷 반환 확인
4. ✅ 잘못된 승자 ID 보고 시 에러 확인

---

## ✅ 최종 검증 완료

### 상태 전환
- [x] 중복 상태 업데이트 제거
- [x] 브래킷 생성 실패 시 상태 유지
- [x] 트랜잭션으로 원자성 보장

### 브래킷 생성
- [x] 중복 생성 방지
- [x] 기존 브래킷 반환
- [x] 에러 처리 개선

### 매치 진행
- [x] 매치 시작 전 검증
- [x] 결과 보고 검증
- [x] 승자 진출 로직

### 에러 처리
- [x] 명확한 에러 메시지
- [x] WebSocket 에러 이벤트
- [x] 상태 불일치 방지

---

## 🎉 결론

내전 진행 흐름이 안정적으로 작동하도록 개선되었습니다:

1. ✅ 상태 전환 로직 정상 작동
2. ✅ 브래킷 중복 생성 방지
3. ✅ 에러 처리 강화
4. ✅ 상태 불일치 방지
5. ✅ 각 단계별 검증 완료

**모든 단계에서 적절한 검증과 에러 처리가 이루어지며, 문제없이 이용할 수 있습니다.**

---

## 📚 관련 문서

- [코드 리뷰 및 개선점](./MATCH_CODE_REVIEW.md)
- [적용된 개선사항](./MATCH_IMPROVEMENTS_APPLIED.md)
- [성능 최적화](./PERFORMANCE_OPTIMIZATIONS.md)
- [파일 분리 리팩토링](./FILE_REFACTORING_COMPLETE.md)
- [내전 진행 흐름 분석](./MATCH_FLOW_ANALYSIS.md)
- [문제점 및 해결](./MATCH_FLOW_ISSUES_FIXED.md)
